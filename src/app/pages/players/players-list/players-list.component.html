<div class="players-page">
  <div class="header-container">
    <h1 class="page-title">Players</h1>
    <div class="search-filters">
      <div class="search-box">
        <nb-form-field>
          <nb-icon nbPrefix icon="search-outline" pack="eva"></nb-icon>
          <input
            type="text"
            nbInput
            fullWidth
            placeholder="Search for a player..."
            [(ngModel)]="searchQuery"
            (ngModelChange)="filterPlayers()">
        </nb-form-field>
      </div>
      <div class="filters">
        <nb-select placeholder="Nationality" [(selected)]="selectedNationality" (selectedChange)="filterPlayers()">
          <nb-option [value]="''">All nationalities</nb-option>
          <nb-option *ngFor="let nationality of nationalities" [value]="nationality">{{ nationality }}</nb-option>
        </nb-select>
        <nb-select placeholder="Position" [(selected)]="selectedPosition" (selectedChange)="filterPlayers()">
          <nb-option [value]="''">All positions</nb-option>
          <nb-option *ngFor="let position of positions" [value]="position">{{ position }}</nb-option>
        </nb-select>
        <button nbButton status="primary" (click)="goToAiRecommendation()" class="ai-recommendation-btn">
          <nb-icon icon="bulb-outline" pack="eva"></nb-icon>
          Recommandation IA
        </button>
      </div>
    </div>
  </div>

  <!-- AI Recommendation Panel -->
  <div *ngIf="showAiRecommendation" class="ai-recommendation-panel" [@fadeIn]>
    <div class="recommendation-header">
      <div class="header-title">
        <nb-icon icon="bulb-outline" pack="eva" class="glow-icon"></nb-icon>
        <h2>AI Recommendations</h2>
      </div>
      <button nbButton ghost (click)="toggleAiRecommendation()" class="close-button">
        <nb-icon icon="close-outline" pack="eva"></nb-icon>
      </button>
    </div>

    <div *ngIf="!isLoadingRecommendation && !recommendationResult && !selectedRecommendationType" class="recommendation-options">
      <h3>Choose a recommendation type</h3>
      <p class="description">Select one of our AI recommendation options to find the perfect players for your team.</p>

      <div class="recommendation-types">
        <div class="recommendation-type-card" (click)="selectRecommendationType('tactical')">
          <div class="type-icon">
            <nb-icon icon="pantone-outline" pack="eva"></nb-icon>
          </div>
          <div class="type-info">
            <h4>Tactical Fit</h4>
            <p>Find players that match your team's tactical style and formation</p>
          </div>
        </div>

        <div class="recommendation-type-card" (click)="selectRecommendationType('budget')">
          <div class="type-icon">
            <nb-icon icon="trending-up-outline" pack="eva"></nb-icon>
          </div>
          <div class="type-info">
            <h4>Budget Optimization</h4>
            <p>Discover the best players within your budget constraints</p>
          </div>
        </div>

        <div class="recommendation-type-card" (click)="selectRecommendationType('potential')">
          <div class="type-icon">
            <nb-icon icon="star-outline" pack="eva"></nb-icon>
          </div>
          <div class="type-info">
            <h4>Future Potential</h4>
            <p>Identify young talents with the highest development potential</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Tactical Fit Form -->
    <div *ngIf="selectedRecommendationType === 'tactical' && !isLoadingRecommendation && !recommendationResult" class="recommendation-form" [@fadeIn]>
      <div class="form-header">
        <button nbButton ghost size="small" (click)="backToRecommendationTypes()" class="back-button">
          <nb-icon icon="arrow-back-outline" pack="eva"></nb-icon>
          Back
        </button>
        <h3>Tactical Fit Recommendation</h3>
      </div>

      <form [formGroup]="tacticalForm" (ngSubmit)="submitTacticalForm()">
        <div class="form-row">
          <div class="form-group">
            <label class="label">Formation</label>
            <nb-select fullWidth formControlName="formation">
              <nb-option value="4-3-3">4-3-3 (Attacking)</nb-option>
              <nb-option value="4-2-3-1">4-2-3-1 (Balanced)</nb-option>
              <nb-option value="3-5-2">3-5-2 (Wing Play)</nb-option>
              <nb-option value="4-4-2">4-4-2 (Counter Attack)</nb-option>
              <nb-option value="5-3-2">5-3-2 (Defensive)</nb-option>
            </nb-select>
          </div>

          <div class="form-group">
            <label class="label">Playing Style</label>
            <nb-select fullWidth formControlName="playingStyle">
              <nb-option value="possession">Possession</nb-option>
              <nb-option value="counter">Counter Attack</nb-option>
              <nb-option value="pressing">High Pressing</nb-option>
              <nb-option value="direct">Direct Play</nb-option>
            </nb-select>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="label">Position Needed</label>
            <nb-select fullWidth formControlName="position">
              <nb-option value="goalkeeper">Goalkeeper</nb-option>
              <nb-option value="defender">Defender</nb-option>
              <nb-option value="midfielder">Midfielder</nb-option>
              <nb-option value="forward">Forward</nb-option>
            </nb-select>
          </div>

          <div class="form-group">
            <label class="label">Experience Level</label>
            <nb-select fullWidth formControlName="experience">
              <nb-option value="young">Young Talent (17-21)</nb-option>
              <nb-option value="prime">Prime Age (22-28)</nb-option>
              <nb-option value="experienced">Experienced (29+)</nb-option>
            </nb-select>
          </div>
        </div>

        <div class="form-group">
          <label class="label">Key Attributes (select up to 3)</label>
          <nb-select multiple fullWidth formControlName="keyAttributes" [selected]="selectedAttributes" (selectedChange)="updateSelectedAttributes($event)">
            <nb-option value="speed">Speed</nb-option>
            <nb-option value="technique">Technical Ability</nb-option>
            <nb-option value="passing">Passing</nb-option>
            <nb-option value="shooting">Shooting</nb-option>
            <nb-option value="defense">Defensive Skills</nb-option>
            <nb-option value="physical">Physical Strength</nb-option>
            <nb-option value="vision">Vision & Intelligence</nb-option>
          </nb-select>
        </div>

        <button nbButton status="primary" [disabled]="tacticalForm.invalid" type="submit" class="submit-btn">
          <nb-icon icon="flash-outline" pack="eva"></nb-icon>
          Generate Recommendations
        </button>
      </form>
    </div>

    <!-- Budget Optimization Form -->
    <div *ngIf="selectedRecommendationType === 'budget' && !isLoadingRecommendation && !recommendationResult" class="recommendation-form" [@fadeIn]>
      <div class="form-header">
        <button nbButton ghost size="small" (click)="backToRecommendationTypes()" class="back-button">
          <nb-icon icon="arrow-back-outline" pack="eva"></nb-icon>
          Back
        </button>
        <h3>Budget Optimization</h3>
      </div>

      <form [formGroup]="budgetForm" (ngSubmit)="submitBudgetForm()">
        <div class="form-row">
          <div class="form-group">
            <label class="label">Maximum Budget (in millions €)</label>
            <input type="number" nbInput fullWidth formControlName="maxBudget" placeholder="Enter maximum budget">
          </div>

          <div class="form-group">
            <label class="label">Position Needed</label>
            <nb-select fullWidth formControlName="position">
              <nb-option value="goalkeeper">Goalkeeper</nb-option>
              <nb-option value="defender">Defender</nb-option>
              <nb-option value="midfielder">Midfielder</nb-option>
              <nb-option value="forward">Forward</nb-option>
            </nb-select>
          </div>
        </div>

        <div class="form-group">
          <label class="label">Priority</label>
          <nb-radio-group formControlName="priority" class="priority-options">
            <nb-radio value="quality">Quality (best players possible within budget)</nb-radio>
            <nb-radio value="value">Value for money (best price/quality ratio)</nb-radio>
            <nb-radio value="potential">Future potential (players who will increase in value)</nb-radio>
          </nb-radio-group>
        </div>

        <div class="form-group">
          <label class="label">League Preference</label>
          <nb-select fullWidth formControlName="league">
            <nb-option value="any">Any League</nb-option>
            <nb-option value="premier">Premier League</nb-option>
            <nb-option value="laliga">La Liga</nb-option>
            <nb-option value="bundesliga">Bundesliga</nb-option>
            <nb-option value="seriea">Serie A</nb-option>
            <nb-option value="ligue1">Ligue 1</nb-option>
            <nb-option value="other">Other Leagues</nb-option>
          </nb-select>
        </div>

        <button nbButton status="primary" [disabled]="budgetForm.invalid" type="submit" class="submit-btn">
          <nb-icon icon="flash-outline" pack="eva"></nb-icon>
          Generate Recommendations
        </button>
      </form>
    </div>

    <!-- Future Potential Form -->
    <div *ngIf="selectedRecommendationType === 'potential' && !isLoadingRecommendation && !recommendationResult" class="recommendation-form" [@fadeIn]>
      <div class="form-header">
        <button nbButton ghost size="small" (click)="backToRecommendationTypes()" class="back-button">
          <nb-icon icon="arrow-back-outline" pack="eva"></nb-icon>
          Back
        </button>
        <h3>Future Potential Finder</h3>
      </div>

      <form [formGroup]="potentialForm" (ngSubmit)="submitPotentialForm()">
        <div class="form-row">
          <div class="form-group">
            <label class="label">Age Range</label>
            <nb-select fullWidth formControlName="ageRange">
              <nb-option value="u18">Under 18</nb-option>
              <nb-option value="u21">Under 21</nb-option>
              <nb-option value="u23">Under 23</nb-option>
            </nb-select>
          </div>

          <div class="form-group">
            <label class="label">Position</label>
            <nb-select fullWidth formControlName="position">
              <nb-option value="any">Any Position</nb-option>
              <nb-option value="goalkeeper">Goalkeeper</nb-option>
              <nb-option value="defender">Defender</nb-option>
              <nb-option value="midfielder">Midfielder</nb-option>
              <nb-option value="forward">Forward</nb-option>
            </nb-select>
          </div>
        </div>

        <div class="form-group">
          <label class="label">Development Timeline</label>
          <nb-radio-group formControlName="timeline" class="timeline-options">
            <nb-radio value="immediate">Immediate Impact (Ready to play now)</nb-radio>
            <nb-radio value="short">Short Term (1-2 seasons)</nb-radio>
            <nb-radio value="long">Long Term (3+ seasons)</nb-radio>
          </nb-radio-group>
        </div>

        <div class="form-group">
          <label class="label">Scouting Region</label>
          <nb-select multiple fullWidth formControlName="regions" [selected]="selectedRegions" (selectedChange)="updateSelectedRegions($event)">
            <nb-option value="europe">Europe</nb-option>
            <nb-option value="southamerica">South America</nb-option>
            <nb-option value="northamerica">North America</nb-option>
            <nb-option value="africa">Africa</nb-option>
            <nb-option value="asia">Asia</nb-option>
          </nb-select>
        </div>

        <button nbButton status="primary" [disabled]="potentialForm.invalid" type="submit" class="submit-btn">
          <nb-icon icon="flash-outline" pack="eva"></nb-icon>
          Generate Recommendations
        </button>
      </form>
    </div>

    <div *ngIf="isLoadingRecommendation" class="loader-container">
      <div class="loader-content">
        <nb-spinner size="large" status="primary"></nb-spinner>
        <div class="loader-text">
          <h3>Our AI is analyzing the data...</h3>
          <p>We're analyzing thousands of players and statistics to find the best recommendations based on your criteria.</p>
        </div>
      </div>
    </div>

    <div *ngIf="recommendationResult" class="recommendation-results" [@fadeIn]>
      <div class="results-header">
        <div class="model-info">
          <nb-icon [icon]="getRecommendationTypeIcon()" pack="eva"></nb-icon>
          <h3>{{ getRecommendationTypeLabel() }}</h3>
        </div>

        <div class="confidence-score">
          <span class="score-label">Confidence:</span>
          <span class="score-value">{{ recommendationResult.confidence }}%</span>
          <nb-progress-bar [value]="recommendationResult.confidence" size="tiny" [status]="getConfidenceStatus(recommendationResult.confidence)"></nb-progress-bar>
        </div>
      </div>

      <div class="explanation">
        <p>{{ recommendationResult.explanation }}</p>
      </div>

      <div class="recommended-players">
        <div *ngFor="let player of recommendationResult.players; let i = index" class="player-recommendation-card" [@slideIn]="{value: '', params: {delay: i * 200}}">
          <div class="compatibility-badge" *ngIf="player.compatibility">
            {{ player.compatibility }}%
          </div>

          <div class="player-photo">
            <img [src]="player.photo" [alt]="player.name"
                 [ngClass]="{'default-image': player.useDefaultImage}"
                 (error)="handleImageError(player)">
          </div>

          <div class="player-info">
            <h4 class="player-name">{{ player.name }}</h4>

            <div class="player-details">
              <span class="player-club">{{ player.club }}</span>
              <span class="player-position" [ngClass]="getPositionClass(player.position)">
                {{ getPositionLabel(player.position) }}
              </span>
            </div>

            <div class="player-stats">
              <div class="stat-item">
                <div class="stat-value">{{ player.age }}</div>
                <div class="stat-label">Age</div>
              </div>
              <div class="stat-item">
                <div class="stat-value">{{ player.marketValue }}M€</div>
                <div class="stat-label">Value</div>
              </div>
              <div class="stat-item">
                <div class="stat-value">{{ player.goals }}</div>
                <div class="stat-label">Goals</div>
              </div>
            </div>
          </div>

          <div class="player-actions">
            <button nbButton outline status="primary" (click)="viewPlayerProfile(player)">
              View profile
            </button>
          </div>
        </div>
      </div>

      <div class="text-center mt-4">
        <button nbButton outline status="basic" (click)="resetRecommendation()" class="reset-btn">
          <nb-icon icon="refresh-outline" pack="eva"></nb-icon>
          Try another recommendation
        </button>
      </div>
    </div>
  </div>

  <!-- Players Grid with New Modern Cards -->
  <div class="modern-players-grid" [class.with-recommendation]="showAiRecommendation">
    <ngx-player-card
      *ngFor="let player of filteredPlayers"
      [player]="player"
      [showActions]="true"
      (profileClick)="viewPlayerProfile($event)"
      (contactClick)="contactPlayer($event)">
    </ngx-player-card>
  </div>
</div>

<!-- Modal du profil joueur -->
<ng-template #playerProfileModal let-ref="dialogRef">
  <nb-card class="profile-modal">
    <nb-card-header class="profile-header">
      <div class="profile-title">
        <h4>Player Profile</h4>
      </div>
      <button nbButton ghost (click)="ref.close()" class="close-button">
        <nb-icon icon="close-outline" pack="eva"></nb-icon>
      </button>
    </nb-card-header>
    <nb-card-body>
      <!-- Contenu du profil joueur -->
    </nb-card-body>
  </nb-card>
</ng-template>

<!-- Modal de recommandation IA -->
<ng-template #aiRecommendationModal let-ref="dialogRef">
  <nb-card class="recommendation-modal">
    <nb-card-header class="profile-header">
      <div class="profile-title">
        <nb-icon icon="bulb-outline" pack="eva"></nb-icon>
        <h4>Recommandations IA</h4>
      </div>
      <button nbButton ghost (click)="ref.close()" class="close-button">
        <nb-icon icon="close-outline" pack="eva"></nb-icon>
      </button>
    </nb-card-header>
    <nb-card-body>
      <div *ngIf="!isLoadingRecommendation && !recommendationResult">
        <h5>Choisissez un modèle d'analyse</h5>
        <p class="description">Sélectionnez un modèle d'IA pour obtenir des recommandations personnalisées.</p>

        <div class="model-selection">
          <div class="model-card" [class.selected]="selectedModel === 'fit_score'" (click)="selectModel('fit_score')">
            <nb-icon icon="pantone-outline" pack="eva"></nb-icon>
            <div class="model-name">Compatibilité tactique</div>
            <div class="model-desc">Trouve des joueurs qui s'intègrent parfaitement dans votre système de jeu</div>
          </div>

          <div class="model-card" [class.selected]="selectedModel === 'hidden_value'" (click)="selectModel('hidden_value')">
            <nb-icon icon="trending-up-outline" pack="eva"></nb-icon>
            <div class="model-name">Pépites sous-cotées</div>
            <div class="model-desc">Identifie des talents cachés avec un excellent rapport qualité/prix</div>
          </div>

          <div class="model-card" [class.selected]="selectedModel === 'position_analysis'" (click)="selectModel('position_analysis')">
            <nb-icon icon="options-2-outline" pack="eva"></nb-icon>
            <div class="model-name">Analyse par poste</div>
            <div class="model-desc">Analyse approfondie des joueurs selon leur position spécifique</div>
          </div>
        </div>

        <div class="text-center mt-4">
          <button nbButton status="primary" [disabled]="!selectedModel" (click)="generateRecommendation()">
            <nb-icon icon="flash-outline" pack="eva"></nb-icon>
            Générer des recommandations
          </button>
        </div>
      </div>

      <div *ngIf="isLoadingRecommendation" class="loader-container">
        <div class="loader-content">
          <nb-spinner size="large" status="primary"></nb-spinner>
          <div class="loader-text">
            <h3>Notre IA analyse les données...</h3>
            <p>Nous analysons des milliers de joueurs et de statistiques pour trouver les meilleures recommandations selon vos critères.</p>
          </div>
        </div>
      </div>

      <div *ngIf="recommendationResult" class="recommendation-results">
        <div class="model-info">
          <h5>
            <nb-icon [icon]="getModelIcon(selectedModel)" pack="eva"></nb-icon>
            {{ getModelName(selectedModel) }}
          </h5>
        </div>

        <div class="confidence-score">
          <span class="score-label">Indice de confiance:</span>
          <span class="score-value">{{ recommendationResult.confidence }}%</span>
          <nb-progress-bar [value]="recommendationResult.confidence" size="tiny" [status]="getConfidenceStatus(recommendationResult.confidence)"></nb-progress-bar>
        </div>

        <div class="explanation">
          <p>{{ recommendationResult.explanation }}</p>
        </div>

        <div class="recommended-players">
          <div *ngFor="let player of recommendationResult.players" class="player-recommendation-card">
            <div class="compatibility-badge" *ngIf="player.compatibility">
              {{ player.compatibility }}%
            </div>

            <div class="player-photo">
              <img [src]="player.photo" [alt]="player.name"
                   [ngClass]="{'default-image': player.useDefaultImage}"
                   (error)="handleImageError(player)">
            </div>

            <div class="player-info">
              <h5 class="player-name">{{ player.name }}</h5>

              <div class="player-details">
                <span class="player-club">{{ player.club }}</span>
                <span class="player-position" [ngClass]="getPositionClass(player.position)">
                  {{ getPositionLabel(player.position) }}
                </span>
              </div>

              <div class="player-stats">
                <div class="stat-item">
                  <div class="stat-value">{{ player.age }}</div>
                  <div class="stat-label">Âge</div>
                </div>
                <div class="stat-item">
                  <div class="stat-value">{{ player.marketValue }}M€</div>
                  <div class="stat-label">Valeur</div>
                </div>
                <div class="stat-item">
                  <div class="stat-value">{{ player.goals }}</div>
                  <div class="stat-label">Buts</div>
                </div>
              </div>
            </div>

            <div class="player-actions">
              <button nbButton outline status="primary" (click)="viewPlayerProfile(player)">
                Voir profil
              </button>
            </div>
          </div>
        </div>

        <div class="text-center mt-4">
          <button nbButton outline status="basic" (click)="resetRecommendation()">
            <nb-icon icon="refresh-outline" pack="eva"></nb-icon>
            Essayer un autre modèle
          </button>
        </div>
      </div>
    </nb-card-body>
  </nb-card>
</ng-template>





